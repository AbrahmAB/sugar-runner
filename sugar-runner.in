#!/bin/bash

helpersdir=@helpersdir@
display=`$helpersdir/find-free-display`

if [ ! -z $DISPLAY ]; then
    SUGAR_RUNNER_XKBCONFIG=`mktemp -t sugar-xkbconfig-XXXXXX`
    setxkbmap -print > $SUGAR_RUNNER_XKBCONFIG
    export SUGAR_RUNNER_XKBCONFIG
fi

if [ -z $DISPLAY ]; then
    grep -q "allowed_users=anybody" /etc/X11/Xwrapper.config
    if [ $? -eq 1 ]; then
        echo "We need to allow everybody to run the X server"
        sudo -k $helpersdir/tweak-xwrapper
    fi

    tty_num=`tty | grep -oE '[0-9]+$'`
    xinit $helpersdir/xinitrc -- $display vt$tty_num
else
    screen_dpi=`$helpersdir/get-screen-dpi`
    xephyr_options="-dpi $screen_dpi"

    xidfile=`mktemp -t sugar-xephyr-xid-XXXXXX`
    $helpersdir/xephyr-window $SUGAR_RUNNER_RESOLUTION > $xidfile &
    xephyrwindowpid=$!

    while [ ! -s $xidfile ]
    do
        sleep 1
    done

    xephyr_options="$xephyr_options -parent `cat $xidfile`"
    xinit $helpersdir/xinitrc -- /usr/bin/Xephyr $display $xephyr_options

    kill $xephyrwindowpid
fi
