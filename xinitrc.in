#!/usr/bin/python

import os
import subprocess

helpers_dir="@helpersdir@"

devnull = open("/dev/null")

def _write_env(env_path):
    with open(env_path, "w") as f:
        for variable in ["DISPLAY", "DBUS_SESSION_BUS_ADDRESS"]:
            f.write("%s=%s\n" % (variable, os.environ[variable]))

def _setup_outputs():
    """Sugar doesn't handle multiple outputs properly. To avoid issues
       we keep the first output in the list returned by xrandr and turn
       off everything else.
    """

    list_outputs_path = os.path.join(helpers_dir, "list-outputs")
    outputs = subprocess.check_output([list_outputs_path])
    splitted = outputs.strip().split("\n")

    on_output = os.environ.get("SUGAR_RUNNER_OUTPUT", splitted[0])
    for output in splitted:
        if output != on_output:
            subprocess.check_call(["xrandr", "--output", output, "--off"])

def _load_xkb_config():
    if "SUGAR_RUNNER_XKBCONFIG" not in os.environ:
        return

    with open(os.environ["SUGAR_RUNNER_XKBCONFIG"]) as f:
        config = f.read()
 
    process = subprocess.Popen(["xkbcomp", "-", os.environ["DISPLAY"]],
                               stdin=subprocess.PIPE, stdout=devnull)
    process.communicate(input=config)

if "SUGAR_RUNNER_ENV_PATH" in os.environ:
    _write_env(os.environ["SUGAR_RUNNER_ENV_PATH"])

_setup_outputs()
_load_xkb_config()

run_with_keyring_path = os.path.join(helpers_dir, "run-with-keyring")
subprocess.check_call(["dbus-launch", "--exit-with-session",
                       run_with_keyring_path, "sugar"])
