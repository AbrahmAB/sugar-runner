#!/bin/bash

helpersdir=@helpersdir@

unset GPG_AGENT_INFO
unset SSH_AUTH_SOCK
unset GNOME_KEYRING_CONTROL
unset GNOME_KEYRING_PID
unset SESSION_MANAGER

# Sugar doesn't handle multiple outputs properly. To avoid issues we keep the
# first output in the list returned by xrandr and turn off everything else.

OUTPUTS=`$helpersdir/list-outputs`

for output in $OUTPUTS
do
   # Default to the first output in the list
   if [ -z $SUGAR_EMULATOR_OUTPUT ]; then
       SUGAR_EMULATOR_OUTPUT=$output
   fi

   if [ $SUGAR_EMULATOR_OUTPUT != $output ]; then
       xrandr --output $output --off
   fi
done

if [ ! -z $SUGAR_EMULATOR_XKBCONFIG ]; then
    cat $SUGAR_EMULATOR_XKBCONFIG | xkbcomp - $DISPLAY 2> /dev/null
    rm $SUGAR_EMULATOR_XKBCONFIG
fi

if [ -z $XDG_DATA_HOME ]; then
    echo "XDG_DATA_HOME must be defined."
    exit 1
fi

# Setup an unencrypted keyring so that it
# doesn't bother us with password dialogs 
mkdir -p $XDG_DATA_HOME

keyringsdir=$XDG_DATA_HOME/keyrings

if [ ! -d "$keyringsdir" ]; then
    mkdir -p $keyringsdir
    echo "default" > $keyringsdir/default
    cat >> $keyringsdir/default.keyring <<EOF
[keyring]
display-name=default
lock-on-idle=false
lock-timeout=0
EOF

fi

dbus-launch --exit-with-session $helpersdir/run-with-keyring sugar
